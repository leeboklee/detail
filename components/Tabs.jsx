'use client';

import React, { useState, useEffect, Suspense } from 'react';

import Labels from '@/src/shared/labels';
import { useAppContext } from './AppContext.Context';
import { BOOKING_SECTION_STYLES } from './layout/LayoutStyles';

// Ïù∏ÎùºÏù∏ Í∞ùÏã§ Ìé∏ÏßëÍ∏∞ ÎèôÏ†Å ÏûÑÌè¨Ìä∏
const InlineRoomEditor = React.lazy(() => import('./inline/InlineRoomEditor'));
// ÏöîÍ∏àÌëú Ïª¥Ìè¨ÎÑåÌä∏ ÎèôÏ†Å ÏûÑÌè¨Ìä∏
const PriceTable = React.lazy(() => import('./price/PriceTable'));
// Ìå®ÌÇ§ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏ ÎèôÏ†Å ÏûÑÌè¨Ìä∏
const Package = React.lazy(() => import('./package/Package'));

const Tabs = () => {
  const { sections, hotelInfo, bookingInfo, layoutInfo, setHotelInfo } = useAppContext();
  const [hasMounted, setHasMounted] = useState(false);
  const [activeTab, setActiveTab] = useState(null);
  const [rooms, setRooms] = useState([]);

  // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎßàÏö¥Ìä∏ ÌôïÏù∏
  useEffect(() => {
    setHasMounted(true);
  }, []);

  // hotelInfo Î≥ÄÍ≤Ω Ïãú ÎØ∏Î¶¨Î≥¥Í∏∞ Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    console.log('hotelInfo ÏóÖÎç∞Ïù¥Ìä∏Îê®:', hotelInfo);
  }, [hotelInfo]);

  // bookingInfo Î≥ÄÍ≤Ω Ïãú ÎØ∏Î¶¨Î≥¥Í∏∞ Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏  
  useEffect(() => {
    console.log('bookingInfo ÏóÖÎç∞Ïù¥Ìä∏Îê®:', bookingInfo);
  }, [bookingInfo]);

  // Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú hotelInfoÏóê Ï†ÄÏû•
  useEffect(() => {
    try {
      if (rooms && rooms.length > 0 && setHotelInfo) {
        setHotelInfo('rooms', rooms);
        console.log('Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏Îê®:', rooms);
      }
    } catch (error) {
      console.error('Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
    }
  }, [rooms, setHotelInfo]);

  // Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞ Î°úÎìú
  useEffect(() => {
    try {
      if (hotelInfo?.rooms && Array.isArray(hotelInfo.rooms)) {
        setRooms(hotelInfo.rooms);
      }
    } catch (error) {
      console.error('Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
      setRooms([]);
    }
  }, [hotelInfo?.rooms]);

  // Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
  const handleRoomsChange = (updatedRooms) => {
    try {
      if (Array.isArray(updatedRooms)) {
        setRooms(updatedRooms);
      } else {
        console.warn('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞:', updatedRooms);
        setRooms([]);
      }
    } catch (error) {
      console.error('Í∞ùÏã§ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
      setRooms([]);
    }
  };

  // ÏÑπÏÖòÎ≥Ñ ÎÇ¥Ïö© ÏÉùÏÑ± Ìï®Ïàò
  const generateSectionContent = (section) => {
    switch (section.id) {
      case 'hotel':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üè® Ìò∏ÌÖî Ï†ïÎ≥¥</h2>
            {hotelInfo?.name ? (
              <div className="space-y-3 sm:space-y-4">
                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 sm:p-6 rounded-lg">
                  <h1 className="text-xl sm:text-3xl font-bold mb-1 sm:mb-2">{hotelInfo.name}</h1>
                  {hotelInfo.subtitle && <p className="text-sm sm:text-lg opacity-90">{hotelInfo.subtitle}</p>}
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-6">
                  {hotelInfo?.address && (
                    <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                      <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">üìç Ï£ºÏÜå</h3>
                      <p className="text-gray-600 text-sm sm:text-base break-words leading-relaxed">{hotelInfo.address}</p>
                    </div>
                  )}
                  
                  {hotelInfo?.description && (
                    <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                      <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">üìù ÏÜåÍ∞ú</h3>
                      <p className="text-gray-600 text-sm sm:text-base break-words leading-relaxed">{hotelInfo.description}</p>
                    </div>
                  )}
                  
                  {hotelInfo?.checkin_time && (
                    <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                      <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">üïí Ï≤¥ÌÅ¨Ïù∏</h3>
                      <p className="text-gray-600 text-sm sm:text-base leading-relaxed">{hotelInfo.checkin_time}</p>
                    </div>
                  )}
                  
                  {hotelInfo?.checkout_time && (
                    <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                      <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">üïê Ï≤¥ÌÅ¨ÏïÑÏõÉ</h3>
                      <p className="text-gray-600 text-sm sm:text-base leading-relaxed">{hotelInfo.checkout_time}</p>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="text-center text-gray-500 py-6 sm:py-8">
                <p className="text-sm sm:text-base">Ìò∏ÌÖî Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
              </div>
            )}
          </div>
        );
        
      case 'package':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6">
              <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-0">üì¶ Ìå®ÌÇ§ÏßÄ Ï†ïÎ≥¥</h2>
            </div>
            
            {/* Ìå®ÌÇ§ÏßÄ Ìé∏ÏßëÍ∏∞ */}
            <Suspense fallback={<div className="text-center py-4 text-sm">Ìå®ÌÇ§ÏßÄ Ìé∏ÏßëÍ∏∞ Î°úÎî© Ï§ë...</div>}>
              <Package 
                value={hotelInfo?.packages || []}
                onChange={(packages) => {
                  try {
                    if (setHotelInfo) {
                      setHotelInfo('packages', packages);
                      console.log('Ìå®ÌÇ§ÏßÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏Îê®:', packages);
                    }
                  } catch (error) {
                    console.error('Ìå®ÌÇ§ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                  }
                }}
              />
            </Suspense>

            {/* Ìå®ÌÇ§ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
            {hotelInfo?.packages && hotelInfo.packages.length > 0 && (
              <div className="mt-6 sm:mt-8">
                <h3 className="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üìã Ìå®ÌÇ§ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                  {hotelInfo.packages.map((pkg, index) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-3 sm:p-4">
                      <div className="flex items-center justify-between mb-2 sm:mb-3">
                        <h4 className="font-semibold text-gray-800 text-sm sm:text-base truncate pr-2">{pkg.name || `Ìå®ÌÇ§ÏßÄ ${index + 1}`}</h4>
                        <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex-shrink-0">
                          ‚Ç©{pkg.price?.toLocaleString() || '0'}
                        </span>
                      </div>
                      
                      {pkg.description && (
                        <p className="text-sm text-gray-600 mb-2 break-words">{pkg.description}</p>
                      )}
                      
                      <div className="space-y-1 sm:space-y-2 text-xs sm:text-sm text-gray-600">
                        {pkg.salesPeriod?.start && pkg.salesPeriod?.end && (
                          <p><strong>ÌåêÎß§Í∏∞Í∞Ñ:</strong> {pkg.salesPeriod.start} ~ {pkg.salesPeriod.end}</p>
                        )}
                        {pkg.stayPeriod?.start && pkg.stayPeriod?.end && (
                          <p><strong>Ìà¨ÏàôÍ∏∞Í∞Ñ:</strong> {pkg.stayPeriod.start} ~ {pkg.stayPeriod.end}</p>
                        )}
                        {pkg.productComposition && (
                          <p><strong>ÏÉÅÌíàÍµ¨ÏÑ±:</strong> <span className="break-words">{pkg.productComposition}</span></p>
                        )}
                        {pkg.includes && pkg.includes.length > 0 && (
                          <div>
                            <strong>Ìè¨Ìï®ÏÇ¨Ìï≠:</strong>
                            <div className="flex flex-wrap gap-1 mt-1">
                              {pkg.includes.map((include, idx) => (
                                <span key={idx} className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">
                                  {include}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {pkg.notes && pkg.notes.length > 0 && (
                          <div>
                            <strong>Ïú†ÏùòÏÇ¨Ìï≠:</strong>
                            <div className="space-y-1 mt-1">
                              {pkg.notes.map((note, idx) => (
                                <p key={idx} className="text-xs text-gray-500 break-words">‚Ä¢ {note}</p>
                              ))}
                            </div>
                          </div>
                        )}
                        {pkg.constraints && pkg.constraints.length > 0 && (
                          <div>
                            <strong>Ï†úÏïΩÏÇ¨Ìï≠:</strong>
                            <div className="space-y-1 mt-1">
                              {pkg.constraints.map((constraint, idx) => (
                                <p key={idx} className="text-xs text-red-600 break-words">‚Ä¢ {constraint}</p>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
              </div>
                  ))}
              </div>
              </div>
            )}
          </div>
        );
        
      case 'notice':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üì¢ ÏïàÎÇ¥ÏÇ¨Ìï≠</h2>
            <div className="space-y-3 sm:space-y-4">
              <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">üì¢ Ï£ºÏöî ÏïàÎÇ¥</h3>
                <p className="text-gray-600 text-sm sm:text-base break-words leading-relaxed">{hotelInfo?.notice || 'Ï£ºÏöî ÏïàÎÇ¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'}</p>
              </div>
              <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠</h3>
                <p className="text-gray-600 text-sm sm:text-base break-words leading-relaxed">{hotelInfo?.warning || 'Ï£ºÏùòÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'}</p>
              </div>
              <div className="bg-gray-50 p-3 sm:p-4 rounded-lg">
                <h3 className="font-semibold text-gray-700 mb-2 text-sm sm:text-base">‚ÑπÔ∏è Ï∂îÍ∞Ä Ï†ïÎ≥¥</h3>
                <p className="text-gray-600 text-sm sm:text-base break-words leading-relaxed">{hotelInfo?.additionalInfo || 'Ï∂îÍ∞Ä Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'}</p>
              </div>
            </div>
          </div>
        );
        
      case 'rooms':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6">
              <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-0">üõèÔ∏è Í∞ùÏã§ Ï†ïÎ≥¥</h2>
              <span className="text-xs sm:text-sm text-gray-500">
                {rooms.length}Í∞ú Í∞ùÏã§
              </span>
            </div>
            
            {/* Ïù∏ÎùºÏù∏ Í∞ùÏã§ Ìé∏ÏßëÍ∏∞ */}
            <Suspense fallback={<div className="text-center py-4 text-sm">Í∞ùÏã§ Ìé∏ÏßëÍ∏∞ Î°úÎî© Ï§ë...</div>}>
              <InlineRoomEditor 
                rooms={rooms} 
                onRoomsChange={handleRoomsChange}
              />
            </Suspense>

            {/* Í∞ùÏã§ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
            {rooms.length > 0 && (
              <div className="mt-6 sm:mt-8">
                <h3 className="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üìã Í∞ùÏã§ ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                  {rooms.map((room, index) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-3 sm:p-4">
                      <div className="flex items-center justify-between mb-2 sm:mb-3">
                        <h4 className="font-semibold text-gray-800 text-sm sm:text-base truncate pr-2">{room.name || `Í∞ùÏã§ ${index + 1}`}</h4>
                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded flex-shrink-0">{room.type}</span>
                      </div>
                      
                      {room.image && (
                        <div className="mb-2 sm:mb-3">
                          <img 
                            src={room.image} 
                            alt={room.name} 
                            className="w-full h-24 sm:h-32 object-cover rounded"
                            onError={(e) => {
                              e.target.style.display = 'none';
                            }}
                          />
                        </div>
                      )}
                      
                      <div className="space-y-1 sm:space-y-2 text-xs sm:text-sm text-gray-600">
                        {room.structure && <p><strong>Íµ¨Ï°∞:</strong> <span className="break-words">{room.structure}</span></p>}
                        {room.bedType && <p><strong>Ïπ®ÎåÄ:</strong> <span className="break-words">{room.bedType}</span></p>}
                        {room.view && <p><strong>Ï†ÑÎßù:</strong> <span className="break-words">{room.view}</span></p>}
                        <p><strong>ÏàòÏö©Ïù∏Ïõê:</strong> Í∏∞Ï§Ä {room.standardCapacity}Î™Ö / ÏµúÎåÄ {room.maxCapacity}Î™Ö</p>
                        {room.description && <p><strong>ÏÑ§Î™Ö:</strong> <span className="break-words">{room.description}</span></p>}
                        {room.amenities && room.amenities.length > 0 && (
                          <div>
                            <strong>Ìé∏ÏùòÏãúÏÑ§:</strong>
                            <div className="flex flex-wrap gap-1 mt-1">
                              {room.amenities.map((amenity, idx) => (
                                <span key={idx} className="text-xs bg-gray-100 text-gray-700 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded">
                                  {amenity}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
              </div>
                  ))}
              </div>
              </div>
            )}
          </div>
        );
        
      case 'price':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <div className="flex items-center justify-between mb-4 sm:mb-6">
              <h2 className="text-lg sm:text-2xl font-bold text-gray-800">üí∞ ÏöîÍ∏àÌëú</h2>
            </div>
            
            {/* ÏöîÍ∏àÌëú Ìé∏ÏßëÍ∏∞ */}
            <Suspense fallback={<div className="text-center py-4 text-sm">ÏöîÍ∏àÌëú Ìé∏ÏßëÍ∏∞ Î°úÎî© Ï§ë...</div>}>
              <PriceTable 
                value={hotelInfo?.priceTable || {}}
                onChange={(priceData) => {
                  try {
                    if (setHotelInfo) {
                      setHotelInfo('priceTable', priceData);
                      console.log('ÏöîÍ∏àÌëú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏Îê®:', priceData);
                    }
                  } catch (error) {
                    console.error('ÏöîÍ∏àÌëú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                  }
                }}
              />
            </Suspense>

            {/* ÏöîÍ∏àÌëú ÎØ∏Î¶¨Î≥¥Í∏∞ */}
            {hotelInfo?.priceTable && Object.keys(hotelInfo.priceTable).length > 0 && (
              <div className="mt-6 sm:mt-8">
                <h3 className="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üìã ÏöîÍ∏àÌëú ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <h4 className="font-semibold text-lg mb-3 text-contrast-fix">{hotelInfo.priceTable.title || 'ÏöîÍ∏àÌëú'}</h4>
                  
                  {hotelInfo.priceTable.priceTable?.roomTypes && (
            <div className="space-y-4">
                      {hotelInfo.priceTable.priceTable.roomTypes.map((roomType, roomIndex) => (
                        <div key={roomIndex} className="border border-gray-200 rounded-lg p-3 bg-white">
                          <h5 className="font-semibold text-gray-800 mb-2 text-contrast-fix">{roomType.name}</h5>
                          {roomType.types && (
                            <div className="space-y-2">
                              {roomType.types.map((type, typeIndex) => (
                                <div key={typeIndex} className="ml-4">
                                  <h6 className="font-medium text-gray-700 text-contrast-fix">{type.name}</h6>
                                  {type.prices && (
                                    <div className="ml-4 text-sm text-gray-600">
                                      {Object.entries(type.prices).map(([period, days]) => (
                                        <div key={period} className="mt-1">
                                          <span className="font-medium text-contrast-fix">{period}: </span>
                                          {Object.entries(days).map(([day, price]) => (
                                            <span key={day} className="mr-3 text-contrast-fix">
                                              {day}: {price.toLocaleString()}Ïõê
                                            </span>
                                          ))}
                                        </div>
                                      ))}
              </div>
                                  )}
              </div>
                              ))}
              </div>
                          )}
            </div>
                      ))}
          </div>
                  )}
                  
                  {hotelInfo.priceTable.notes && hotelInfo.priceTable.notes.length > 0 && (
                    <div className="mt-4">
                      <h5 className="font-semibold text-gray-800 mb-2 text-contrast-fix">üìù ÏïàÎÇ¥ÏÇ¨Ìï≠</h5>
                      <ul className="list-disc list-inside space-y-1 text-sm text-gray-600">
                        {hotelInfo.priceTable.notes.map((note, index) => (
                          <li key={index} className="text-contrast-fix">{note}</li>
                        ))}
                      </ul>
              </div>
                  )}
              </div>
              </div>
            )}
          </div>
        );
        
      case 'booking':
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">üìû ÏòàÏïΩÏïàÎÇ¥</h2>
            <BookingSectionRenderer bookingInfo={bookingInfo} layoutInfo={layoutInfo} />
          </div>
        );
        
      default:
        return (
          <div className="p-3 sm:p-6 bg-white rounded-lg shadow-sm border">
            <h2 className="text-lg sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">{section.label}</h2>
            <div className="text-center text-gray-500 py-6 sm:py-8">
              <p className="text-sm sm:text-base">{section.label} ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
            </div>
          </div>
        );
    }
  };

  // Ï≤´ Î≤àÏß∏ ÌôúÏÑ± ÌÉ≠ ÏÑ§Ï†ï
  useEffect(() => {
    if (hasMounted && sections && sections.length > 0 && activeTab === null) {
      const firstVisibleTab = sections.find((section) => section.visible);
      if (firstVisibleTab) {
        setActiveTab(firstVisibleTab.id);
      }
    }
  }, [hasMounted, sections, activeTab]);

  const handleTabChange = (tabId) => {
    if (hasMounted) {
      setActiveTab(tabId);
    }
  };

  // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎßàÏö¥Ìä∏ Ï†Ñ Î°úÎî© ÏÉÅÌÉú
  if (!hasMounted) {
    return (
      <div className="w-full p-4 text-center text-gray-500">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded mb-4"></div>
          <div className="h-64 bg-gray-100 rounded"></div>
        </div>
      </div>
    );
  }

  if (!sections || sections.length === 0) {
    return <div className="w-full p-4 text-center text-gray-500">ÌÉ≠ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>;
  }

  // Î≥¥Ïù¥Îäî ÏÑπÏÖòÎßå ÌïÑÌÑ∞ÎßÅ
  const visibleSections = sections.filter((section) => section.visible);

  if (visibleSections.length === 0) {
    return <div className="w-full p-4 text-center text-gray-500">ÌëúÏãúÌï† ÏÑπÏÖòÏù¥ ÏóÜÏäµÎãàÎã§.</div>;
  }

  // activeTabÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Ï≤´ Î≤àÏß∏ ÌÉ≠ÏúºÎ°ú ÏÑ§Ï†ï
  if (!activeTab && visibleSections.length > 0) {
    // ÎπÑÎèôÍ∏∞Î°ú ÌÉ≠ ÏÑ§Ï†ïÌïòÏó¨ Î†åÎçîÎßÅ Ï§ë ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∞©ÏßÄ
    setTimeout(() => {
      setActiveTab(visibleSections[0].id);
    }, 0);
    return (
      <div className="w-full p-4 text-center text-gray-500">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded mb-4"></div>
          <div className="h-64 bg-gray-100 rounded"></div>
        </div>
      </div>
    );
  }

  // activeTabÏù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï≤´ Î≤àÏß∏ ÌÉ≠ÏúºÎ°ú ÏÑ§Ï†ï
  const currentActiveTab = activeTab && visibleSections.find(s => s.id === activeTab) ? activeTab : visibleSections[0]?.id;

  return (
    <div className="w-full">
      {/* Î™®Î∞îÏùº Î∞òÏùëÌòï ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <div className="border-b border-gray-200 overflow-hidden">
        <nav className="-mb-px flex overflow-x-auto scrollbar-hide" aria-label={Labels.TABS_1}>
          <div className="flex space-x-2 sm:space-x-4 min-w-max px-2 sm:px-0">
          {visibleSections.map((section) => (
            <button
              key={section.id}
              onClick={() => handleTabChange(section.id)}
              className={`
                  flex-shrink-0 px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium transition-all duration-300 whitespace-nowrap
                  ${currentActiveTab === section.id 
                  ? 'border-b-2 border-indigo-500 text-indigo-600' 
                  : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}
              `}
            >
              {section.label}
            </button>
          ))}
          </div>
        </nav>
      </div>
      
      {/* Ïª®ÌÖêÏ∏† ÏòÅÏó≠ - Î™®Î∞îÏùº Ìå®Îî© Ï°∞Ï†ï */}
      <div className="mt-2 sm:mt-4">
        {visibleSections.map((section) => (
          <div
            key={section.id}
            className={`
              ${currentActiveTab === section.id ? 'block' : 'hidden'}
              transition-opacity duration-300 ease-in-out
            `}
          >
            {generateSectionContent(section)}
          </div>
        ))}
      </div>
    </div>
  );
};

// ÏòàÏïΩÏïàÎÇ¥ ÏÑπÏÖò Î†åÎçîÎü¨ Ïª¥Ìè¨ÎÑåÌä∏
const BookingSectionRenderer = ({ bookingInfo, layoutInfo }) => {
  const [renderedContent, setRenderedContent] = useState('');
  
  useEffect(() => {
    try {
      console.log('BookingSectionRenderer ÏóÖÎç∞Ïù¥Ìä∏:', bookingInfo);
      
      // ÏàôÎ∞ïÍ∂å Íµ¨Îß§ÏïàÎÇ¥ÏôÄ Ï∞∏Í≥†ÏÇ¨Ìï≠ Î∂ÑÎ¶¨ Î†åÎçîÎßÅ
      let content = '';
      
      // ÏàôÎ∞ïÍ∂å Íµ¨Îß§ÏïàÎÇ¥ ÏÑπÏÖò
      if (bookingInfo?.bookingText) {
        const lines = bookingInfo.bookingText.split('\n');
        const formattedContent = lines.map((line, index) => {
          if (line.trim() === '') return '<br>';
          
          // Í≤ΩÍ≥† Î©îÏãúÏßÄ (‚ö†Ô∏è Ìè¨Ìï®)
          if (line.includes('‚ö†Ô∏è')) {
            return `<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin: 8px 0; color: #dc2626; font-weight: 600;">${line}</div>`;
          }
          
          // Î≤àÌò∏ Î™©Î°ù (1. 2. Îì±)
          if (line.match(/^\d+\./)) {
            return `<p style="margin: 8px 0; font-weight: 500; color: #374151;">${line}</p>`;
          }
          
          // ÌäπÏàò Î¨∏Ïûê Ìè¨Ìï®Îêú Ï§Ñ (* Îì±)
          if (line.startsWith('*') || line.startsWith('‚Äª')) {
            return `<p style="margin: 4px 0; color: #6b7280; font-size: 13px;">${line}</p>`;
          }
          
          // ÏùºÎ∞ò ÌÖçÏä§Ìä∏
          return `<p style="margin: 4px 0; color: #374151;">${line}</p>`;
        }).join('');
        
        content += `
          <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #0c4a6e; font-size: 20px; font-weight: 700; margin-bottom: 16px;">üè® ÏàôÎ∞ïÍ∂å Íµ¨Îß§ÏïàÎÇ¥</h3>
            <div style="color: #374151; line-height: 1.8;">
              ${formattedContent}
            </div>
          </div>
        `;
      }
      
      // Ï∞∏Í≥†ÏÇ¨Ìï≠ ÏÑπÏÖò
      if (bookingInfo?.referenceNotes) {
        const lines = bookingInfo.referenceNotes.split('\n');
        const formattedContent = lines.map((line, index) => {
          if (line.trim() === '') return '<br>';
          return `<p style="margin: 4px 0; color: #374151;">${line}</p>`;
        }).join('');
        
        content += `
          <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #92400e; font-size: 20px; font-weight: 700; margin-bottom: 16px;">üìã Ï∞∏Í≥†ÏÇ¨Ìï≠</h3>
            <div style="color: #374151; line-height: 1.8;">
              ${formattedContent}
            </div>
          </div>
        `;
      }
      
      // Ïπ¥ÌÜ° Ï±ÑÎÑê Ï†ïÎ≥¥
      if (bookingInfo?.kakaoChannel) {
        content += `
          <div style="background: #fbbf24; border-radius: 12px; padding: 20px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; color: #92400e; font-weight: 600; font-size: 16px;">
              <span style="font-size: 24px;">üí¨</span>
              <span>${bookingInfo.kakaoChannel}</span>
            </div>
          </div>
        `;
      }
      
      if (content) {
        setRenderedContent(`
          <div class="space-y-4">
            ${content}
          </div>
        `);
        return;
      }
      
      // Í∏∞Ï°¥ BookingInfo ÌòïÏãù (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
      if (bookingInfo?.bookingText) {
        const lines = bookingInfo.bookingText.split('\n');
        const formattedContent = lines.map((line, index) => {
          if (line.trim() === '') return '<br>';
          if (line.includes('‚ö†Ô∏è')) {
            return `<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin: 8px 0; color: #dc2626; font-weight: 600;">${line}</div>`;
          }
          if (line.startsWith('*')) {
            return `<p style="margin: 4px 0; color: #6b7280; font-size: 13px;">${line}</p>`;
          }
          if (line.match(/^\d+\./)) {
            return `<p style="margin: 8px 0; font-weight: 500;">${line}</p>`;
          }
          return `<p style="margin: 4px 0;">${line}</p>`;
        }).join('');

        setRenderedContent(`
          <div class="p-6 bg-white rounded-lg shadow-sm border text-contrast-fix">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìû ÏòàÏïΩÏïàÎÇ¥</h2>
            <div class="space-y-2 leading-relaxed">
              ${formattedContent}
            </div>
          </div>
        `);
        return;
      }
      
      // Í∏∞Î≥∏ Î©îÏãúÏßÄ
      setRenderedContent(`
        <div class="p-6 bg-white rounded-lg shadow-sm border text-contrast-fix">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">üìû ÏòàÏïΩÏïàÎÇ¥</h2>
          <div class="text-center text-gray-500 py-8">
            <p>ÏòàÏïΩÏïàÎÇ¥ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
          </div>
        </div>
      `);
    } catch (error) {
      console.error('BookingSectionRenderer Ïò§Î•ò:', error);
      setRenderedContent(`
        <div class="p-6 bg-white rounded-lg shadow-sm border text-contrast-fix">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">üìû ÏòàÏïΩÏïàÎÇ¥</h2>
          <div class="text-center text-red-500 py-8">
            <p>ÏòàÏïΩÏïàÎÇ¥ Î†åÎçîÎßÅ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
          </div>
        </div>
      `);
    }
  }, [bookingInfo, layoutInfo]);
  
  return (
    <div 
      className="booking-section-preview"
      dangerouslySetInnerHTML={{ __html: renderedContent }}
    />
  );
};

export default Tabs;
