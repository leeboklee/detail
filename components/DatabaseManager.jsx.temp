import React, { useState } from 'react';
import { useAppContext } from '../context/AppContext';

// í…œí”Œë¦¿ë³„ ì„¹ì…˜ ìˆœì„œ ì •ì˜
const getTemplateSections = (hotelName) => {
  const defaultSections = [
    { id: 'hotel', title: 'í˜¸í…” ì •ë³´', visible: true },
    { id: 'rooms', title: 'ê°ì‹¤ ì •ë³´', visible: true },
    { id: 'facilities', title: 'ë¶€ëŒ€ì‹œì„¤', visible: true },
    { id: 'packages', title: 'íŒ¨í‚¤ì§€', visible: true },
    { id: 'checkin', title: 'ì²´í¬ì¸/ì•„ì›ƒ', visible: true },
    { id: 'period', title: 'ì„±ìˆ˜ê¸°/ë¹„ìˆ˜ê¸°', visible: true },
    { id: 'cancel', title: 'ì·¨ì†Œ/í™˜ë¶ˆ', visible: true },
    { id: 'booking', title: 'ì˜ˆì•½ ì•ˆë‚´', visible: true },
    { id: 'notices', title: 'ê³µì§€ì‚¬í•­', visible: true },
    { id: 'pricing', title: 'ìš”ê¸ˆ ì •ë³´', visible: true }
  ];

  // ë¹„ë°œë””íŒŒí¬ ì „ìš© ì„¹ì…˜ ìˆœì„œ
  if (hotelName && hotelName.includes('ë¹„ë°œë””íŒŒí¬')) {
    return [
      { id: 'hotel', title: 'í˜¸í…” ì •ë³´', visible: true },
      { id: 'rooms', title: 'ê°ì‹¤ ì •ë³´', visible: true },
      { id: 'packages', title: 'íŒ¨í‚¤ì§€', visible: true },
      { id: 'period', title: 'ì„±ìˆ˜ê¸°/ë¹„ìˆ˜ê¸°', visible: true },
      { id: 'facilities', title: 'ë¶€ëŒ€ì‹œì„¤', visible: true },
      { id: 'checkin', title: 'ì²´í¬ì¸/ì•„ì›ƒ', visible: true },
      { id: 'cancel', title: 'ì·¨ì†Œ/í™˜ë¶ˆ', visible: true },
      { id: 'booking', title: 'ì˜ˆì•½ ì•ˆë‚´', visible: true },
      { id: 'notices', title: 'ê³µì§€ì‚¬í•­', visible: true },
      { id: 'pricing', title: 'ìš”ê¸ˆ ì •ë³´', visible: true }
    ];
  }

  return defaultSections;
};

const DatabaseManager = ({ onClose, onLoad }) => {
  const { templateList, setHotelData, updateHotelDataDirectly } = useAppContext();
  const [searchTerm, setSearchTerm] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  console.log('ğŸ”„ DatabaseManager: ë Œë”ë§ ì‹œì‘');
  console.log('ğŸ“Š DatabaseManager: AppContextë¡œë¶€í„° ë°›ì€ í…œí”Œë¦¿ ê°œìˆ˜:', templateList.length);

  // ê²€ìƒ‰ í•„í„°ë§ëœ í…œí”Œë¦¿ ëª©ë¡
  const filteredTemplates = templateList.filter(template => 
    template.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    template.description?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  console.log('ğŸ” DatabaseManager: í•„í„°ë§ëœ í…œí”Œë¦¿ ê°œìˆ˜:', filteredTemplates.length);

  // í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
  const loadTemplate = async (templateId) => {
    setIsLoading(true);
    console.log('ğŸ”„ DatabaseManager: í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘. ID:', templateId);

    try {
      // ê°œë³„ í˜¸í…” ë°ì´í„° API í˜¸ì¶œ
      const response = await fetch(`/api/hotels/${templateId}`);
      if (!response.ok) {
        throw new Error(`í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
      }

      const templateData = await response.json();
      console.log('âœ… DatabaseManager: í…œí”Œë¦¿ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', templateData.name);

      // AppContextì˜ hotelData êµ¬ì¡°ì— ë§ê²Œ ë³€í™˜
      const transformedData = {
        hotel: {
          id: templateData.id || '',
          name: templateData.name || '',
          address: templateData.address || '',
          description: templateData.description || '',
          phone: templateData.phone || '',
          imageUrl: templateData.imageUrl || templateData.image_url || '',
          checkin_time: templateData.checkInTime || templateData.checkin_time || '15:00',
          checkout_time: templateData.checkout_time || '11:00'
        },
        rooms: (templateData.rooms || []).map(room => ({
          roomType: room.type || room.name || '',
          view: room.view || '',
          amenities: room.amenities || [],
          bedInfo: room.bedType || '',
          maxOccupancy: room.maxCapacity || 0,
          description: room.description || '',
          imageUrl: room.image || '',
          name: room.name || ''
        })),
        facilities: templateData.facilities || {
          general: [],
          business: [],
          leisure: [],
          dining: []
        },
        packages: (templateData.packages || []).map(pkg => ({
          name: pkg.name || '',
          description: pkg.description || '',
          price: pkg.price || '',
          includes: pkg.options || [],
          additionalDescription: pkg.additionalDescription || '',
          imageUrl: pkg.imageUrl || '',
          saleStartDate: pkg.saleStartDate || '',
          saleEndDate: pkg.saleEndDate || ''
        })),
        checkin: {
          checkInTime: templateData.checkIn?.checkInTime || '15:00',
          checkOutTime: templateData.checkIn?.checkOutTime || '11:00',
          earlyCheckIn: templateData.checkIn?.earlyCheckIn || '',
          lateCheckOut: templateData.checkIn?.lateCheckOut || '',
        },
        period: templateData.period || {
          packageName: '',
          checkInDate: '',
          checkOutDate: '',
          price: '',
          currency: 'KRW',
          notes: '',
          isPackageIncluded: false,
          peakSeason: '',
          offSeason: '',
          specialEvents: [],
          saleStartDate: '',
          saleEndDate: '',
          stayStartDate: '',
          stayEndDate: '',
          checkInTime: '',
          checkOutTime: '',
          earlyBirdDiscount: '',
          lastMinuteDiscount: '',
          specialBenefits: '',
          saleRestrictions: '',
          minStayDays: null,
          maxStayDays: null,
          blackoutDates: [],
          seasonalRates: [],
          weekendSurcharge: null,
          holidaySurcharge: null,
          cancellationPolicy: ''
        },
        cancel: templateData.cancel || {
          description: '',
          offSeasonTitle: '',
          highSeasonTitle: '',
          policies: [
            { period: '', refund: '' },
            { period: '', refund: '' },
            { period: '', refund: '' }
          ],
          freeCancellation: '',
          cancellationFee: '',
          noShow: '',
          modificationPolicy: ''
        },
        pricing: templateData.pricing || {
          basePrice: '',
          currency: 'KRW',
          taxRate: '',
          serviceCharge: '',
          totalPrice: '',
          priceIncludes: [],
          notes: '',
          additionalChargesInfo: '',
          lodges: [],
          dayTypes: [],
          headerLabels: []
        },
        booking: templateData.booking || {
          contactInfo: {
            phone: '',
            email: '',
            website: ''
          },
          policies: [],
          notes: '',
          reservationMethod: '',
          paymentMethods: [],
          confirmationTime: '',
          specialRequests: ''
        },
        notices: (templateData.notices || []).map(notice => ({
          title: notice.title || '',
          content: notice.content || '',
          additionalNotes: notice.additionalNotes || '',
          type: notice.type || ''
        })),
        salePeriod: templateData.salePeriod || '',
        stayPeriod: templateData.stayPeriod || '',
        sections: templateData.sections || {
          hotel: true, rooms: true, facilities: true, packages: true, period: true,
          cancel: true, pricing: true, booking: true, notice: true
        },
        htmlPreviewData: templateData.htmlPreviewData || '',
        selectedTab: 'hotel'
      };

      // AppContextì˜ hotelData ì—…ë°ì´íŠ¸
      updateHotelDataDirectly(transformedData);
      console.log('âœ… DatabaseManager: transformedDataê°€ AppContextì— ì „ë‹¬ë¨. í˜¸í…” ì´ë¦„:', transformedData.hotel.name);

      // ì„¹ì…˜ ìˆœì„œ ì—…ë°ì´íŠ¸
      const sections = getTemplateSections(templateData.name);
      console.log('ğŸ”§ DatabaseManager: ì„¹ì…˜ ìˆœì„œ ì—…ë°ì´íŠ¸:', sections.map(s => s.title));

      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem('hotelData', JSON.stringify(transformedData));
      localStorage.setItem('lastWorkingHotelData', JSON.stringify(transformedData));
      localStorage.setItem('lastWorkingTimestamp', Date.now().toString());

      console.log('âœ… DatabaseManager: í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
      
      // if (onLoad) {
      //   onLoad(transformedData);
      // }
      
      // ëª¨ë‹¬ ë‹«ê¸°
      if (onClose) {
        onClose();
      }

    } catch (error) {
      console.error('âŒ DatabaseManager: í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      alert(`í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-bold">í…œí”Œë¦¿ ëª©ë¡</h2>
        <button
          onClick={onClose}
          className="text-gray-500 hover:text-gray-700 text-xl font-bold"
        >
          Ã—
        </button>
      </div>

      {/* ê²€ìƒ‰ ì…ë ¥ */}
      <div className="mb-4">
        <input
          type="text"
          placeholder="í…œí”Œë¦¿ ê²€ìƒ‰..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      {/* ë¡œë”© ìƒíƒœ */}
      {isLoading && (
        <div className="text-center py-4">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p className="mt-2 text-gray-600">í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      )}

      {/* í…œí”Œë¦¿ ëª©ë¡ */}
      <div className="space-y-3 max-h-96 overflow-y-auto">
        {filteredTemplates.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            {templateList.length === 0 ? 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
          </div>
        ) : (
          filteredTemplates.map((template) => (
            <div
              key={template.id}
              className="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors"
            >
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <h3 className="font-semibold text-lg text-gray-800">
                    {template.name || 'ì´ë¦„ ì—†ìŒ'}
                  </h3>
                  <p className="text-sm text-gray-600 mt-1">
                    ID: {template.id}
                  </p>
                  {template.createdAt && (
                    <p className="text-xs text-gray-500 mt-2">
                      ìƒì„±ì¼: {new Date(template.createdAt).toLocaleDateString()}
                    </p>
                  )}
                </div>
                <button
                  onClick={() => loadTemplate(template.id)}
                  disabled={isLoading}
                  className="ml-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* í•˜ë‹¨ ì •ë³´ */}
      <div className="text-sm text-gray-500 text-center pt-4 border-t">
        ì´ {templateList.length}ê°œì˜ í…œí”Œë¦¿ì´ ìˆìŠµë‹ˆë‹¤.
        {searchTerm && ` (${filteredTemplates.length}ê°œ ê²€ìƒ‰ë¨)`}
      </div>
    </div>
  );
};

export default DatabaseManager;